<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:;base64,=">
  </head>

  <body>

    <button id='open-button'>Open file</button>

    <script type="module">
      import {
        getToken, connect, HttpServer, openDirectory, directoryTreeHandler,
        startTokenFlow, checkTokenFlow
      } from './lib/waygate-js/index.js';

      const SERVER_DOMAIN = "anderspitman.net";

      await checkTokenFlow();

      async function startFlow() {
        await startTokenFlow(
          `https://${SERVER_DOMAIN}/oauth2`,
        );
      }

      const token = getToken();
      if (!token) {
        await startFlow();
      }

      const dirTree = await openDirectory();

      let tunnelDomain;

      const dec = new TextDecoder('utf-8');
      const openButton = document.getElementById('open-button');
      openButton.addEventListener('click', async (e) => {
        const files = await dirTree.addFiles();

        for (const file of files) {
          const div = document.createElement('div');
          const link = document.createElement('a');
          const uri = `https://${tunnelDomain}/${file.name}`
          link.setAttribute('href', uri);
          link.innerText = uri;

          div.appendChild(link);
          document.body.appendChild(div);
        }
      });

      let session;
      try {
        session = await connect({
          serverDomain: SERVER_DOMAIN,
          token,
        });
      }
      catch (e) {
        await startFlow();
      }

      tunnelDomain = session.domain;

      const httpServer = new HttpServer({
        domain: session.domain,
      });

      console.log("serve");
      httpServer.serve(session, directoryTreeHandler(dirTree));

    </script>
  </body>
</html>
