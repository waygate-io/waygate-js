<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:;base64,=">
  </head>

  <body>
    <script type="module">
      import { Client } from './lib/muxado-js/index.js';
      import { Server, ServeMux } from './lib/http-js/index.js';

      const session = new Client({
        serverDomain: "anderspitman.net",
        token: "yolo",
      });

      const mux = new ServeMux();
      const httpServer = new Server({
        handler: mux,
      });

      const enc = new TextEncoder('utf8');
      const CHUNK_LEN = 32*1024;
      const NCHUNKS = 10000;
      let chunkStr = "";
      for (let i = 0; i < CHUNK_LEN; i++ ) {
        chunkStr += "9";
      }
      const chunk = enc.encode(chunkStr);

      mux.handleFunc("/", async (w, r) => {
        console.log(w, r);

        w.headers['Content-Length'] = `${NCHUNKS*chunk.length}`;

        for (let i = 0; i < NCHUNKS; i++) {
          try {
            await w.write(chunk);
          }
          catch (e) {
            console.error("write failed, other side may have cancelled", e);
            break;
          }
        }
      });

      mux.handleFunc("/og", async (w, r) => {
        w.headers = {
          'OG': "Hi there",
          'Content-Length': 8,
          'Content-Type': 'text/plain',
        },

        await w.writeHeader(400);
        await w.write(enc.encode("Hi there"));
      });

      console.log("serve");
      httpServer.serve(session);

    </script>
  </body>
</html>
