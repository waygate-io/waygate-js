<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:;base64,=">
  </head>

  <body>

    <input type='file' id='file-input' />

    <script type="module">
      import { Client } from './lib/muxado-js/index.js';
      import { Server, ServeMux } from './lib/http-js/index.js';

      let file;

      const fileInput = document.getElementById('file-input');
      fileInput.addEventListener('change', (evt) => {
        file = fileInput.files[0];
      });

      const session = new Client({
        serverDomain: "anderspitman.net",
        token: "yolo",
      });

      const mux = new ServeMux();
      const httpServer = new Server({
        handler: mux,
      });

      mux.handleFunc("/file", async (w, r) => {
        if (file) {
          w.headers['Content-Length'] = file.size;
          await file.stream().pipeTo(await w.getWritableStream());
        }
        else {
          console.error("No file selected");
        }
      });

      const enc = new TextEncoder('utf8');

      mux.handleFunc("/og", async (w, r) => {
        w.headers = {
          'OG': "Hi there",
          'Content-Length': 8,
          'Content-Type': 'text/plain',
        },

        await w.writeHeader(400);
        await w.write(enc.encode("Hi there"));
      });

      console.log("serve");
      httpServer.serve(session);

    </script>
  </body>
</html>
