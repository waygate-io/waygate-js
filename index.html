<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:;base64,=">
  </head>

  <body>

    <input type='file' id='file-input' multiple />

    <script type="module">
      import { Client } from './lib/muxado-js/index.js';
      import { Server, ServeMux, parseRangeHeader } from './lib/http-js/index.js';

      const files = {};

      const fileInput = document.getElementById('file-input');
      fileInput.addEventListener('change', (evt) => {

        for (const file of fileInput.files) {

          files[file.name] = file;

          const div = document.createElement('div');
          const link = document.createElement('a');
          const uri = `https://test2.anderspitman.net/${file.name}`
          link.setAttribute('href', uri);
          link.innerText = uri;

          div.appendChild(link);
          document.body.appendChild(div);
        }
      });

      const session = new Client({
        serverDomain: "anderspitman.net",
        token: "yolo",
      });

      const mux = new ServeMux();
      const httpServer = new Server({
        domain: 'test2.anderspitman.net',
        handler: mux,
      });

      mux.handleFunc("/", async (w, r) => {

        console.log(r);

        const url = new URL(r.url);

        const pathParts = url.pathname.split('/');
        const filename = pathParts[pathParts.length - 1];

        const file = files[filename];

        let statusCode = 200;

        if (file) {

          let sendFile = file;
          const contentType = file.type;

          if (r.headers.get('range')) {
            const range = parseRangeHeader(r.headers.get('range'));
            console.log(range);

            if (range.end) {
              sendFile = file.slice(range.start, range.end + 1);
              w.headers['Content-Range'] = `bytes ${range.start}-${range.end}/${file.size}`;
            }
            else {
              sendFile = file.slice(range.start);
              w.headers['Content-Range'] = `bytes ${range.start}-${file.size - 1}/${file.size}`;
            }

            statusCode = 206;
          }

          w.headers['Accept-Ranges'] = 'bytes';
          w.headers['Content-Type'] = contentType;
          w.headers['Content-Length'] = sendFile.size;

          console.log("Serve file", sendFile);

          await w.writeHeader(statusCode);
          await sendFile.stream().pipeTo(await w.getWritableStream());
        }
        else {
          await w.writeHeader(404);
        }
      });

      const enc = new TextEncoder('utf8');

      mux.handleFunc("/og", async (w, r) => {
        w.headers = {
          'OG': "Hi there",
          'Content-Length': 8,
          'Content-Type': 'text/plain',
        },

        await w.writeHeader(400);
        await w.write(enc.encode("Hi there"));
      });

      console.log("serve");
      httpServer.serve(session);

    </script>
  </body>
</html>
